<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pogadaj24 — Prototype</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body { margin:0; font-family:'Poppins', sans-serif; background:#111; color:#fff; }
.container { max-width:1400px; margin:auto; padding:10px; }
.app-header { text-align:center; padding:20px; font-size:2em; font-weight:700; }
.card { background:#222; border-radius:12px; padding:15px; margin:10px 0; }
.btn { padding:8px 16px; margin:5px; border:none; border-radius:6px; cursor:pointer; }
.neon { background:#0ff; color:#000; font-weight:600; }
.ghost { background:transparent; border:2px solid #0ff; color:#0ff; }
.video-container { display:flex; justify-content:center; align-items:flex-start; gap:20px; flex-wrap:wrap; }
.video-stage { position:relative; width:720px; height:480px; background:#000; border-radius:12px; overflow:hidden; }
.local-thumb { position:absolute; bottom:10px; right:10px; width:200px; height:150px; border:2px solid #0ff; border-radius:8px; }
.local-thumb video, .video-stage video { width:100%; height:100%; object-fit:cover; }
.action-bar { margin-top:10px; text-align:center; }
.chat-panel { width:300px; max-height:480px; display:flex; flex-direction:column; }
.chat-box { flex:1; overflow-y:auto; background:#111; padding:10px; border-radius:6px; margin-bottom:10px; font-size:0.9em; }
.chat-input { display:flex; gap:5px; }
.input { flex:1; padding:6px; border-radius:4px; border:none; }
.footer { text-align:center; margin-top:20px; color:#888; }
.modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; }
.modal .panel { background:#222; padding:20px; border-radius:12px; text-align:center; }
</style>
</head>
<body>

<div class="container">
  <header class="app-header">Pogadaj24</header>

  <div class="video-container">
    <div class="card">
      <div class="video-stage">
        <video id="remote" autoplay playsinline></video>
        <div class="local-thumb"><video id="local" autoplay playsinline muted></video></div>
      </div>
      <div class="action-bar">
        <button id="startBtn" class="btn neon">Start</button>
        <button id="nextBtn" class="btn neon">Next</button>
        <button id="muteBtn" class="btn neon">Mute</button>
        <button id="stopBtn" class="btn neon">Stop</button>
      </div>
    </div>

    <div class="chat-panel card">
      <div class="chat-box" id="chatBox"></div>
      <div class="chat-input">
        <input id="chatText" class="input" placeholder="Napisz wiadomość...">
        <button id="sendBtn" class="btn neon">Wyślij</button>
      </div>
    </div>
  </div>

  <footer class="footer">&copy; Pogadaj24 — prototyp</footer>
</div>

<div class="modal" id="loginModal">
  <div class="panel">
    <h2>Witaj w Pogadaj24</h2>
    <p>Wybierz opcję aby rozpocząć:</p>
    <button id="anonBtn" class="btn ghost" style="margin-right:6px;">Wejdź anonimowo</button>
    <button id="loginBtn" class="btn neon">Zaloguj (demo)</button>
  </div>
</div>

<script>
const WEBSOCKET_URL = 'wss://pogadaj24.onrender.com';

const localVideo = document.getElementById('local');
const remoteVideo = document.getElementById('remote');
const startBtn = document.getElementById('startBtn');
const nextBtn = document.getElementById('nextBtn');
const muteBtn = document.getElementById('muteBtn');
const stopBtn = document.getElementById('stopBtn');
const chatBox = document.getElementById('chatBox');
const sendBtn = document.getElementById('sendBtn');
const chatText = document.getElementById('chatText');
const loginModal = document.getElementById('loginModal');
const anonBtn = document.getElementById('anonBtn');
const loginBtn = document.getElementById('loginBtn');

let localStream = null;
let pc = null;
let ws = null;
let isMuted = false;

function addChat(who, msg) {
  const el = document.createElement('div');
  el.innerHTML = `<strong>${who}:</strong> ${msg}`;
  chatBox.appendChild(el);
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function startCamera() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    localVideo.srcObject = localStream;
  } catch (e) {
    addChat('System', 'Brak dostępu do kamery');
    throw e;
  }
}

function initWebSocket() {
  ws = new WebSocket(WEBSOCKET_URL);
  ws.onmessage = e => {
    const data = JSON.parse(e.data);
    if(data.type==='offer') {
      pc.setRemoteDescription(data.offer)
        .then(()=>pc.createAnswer())
        .then(answer=>pc.setLocalDescription(answer))
        .then(()=>ws.send(JSON.stringify({type:'answer',answer:pc.localDescription})));
    } else if(data.type==='answer') {
      pc.setRemoteDescription(data.answer);
    } else if(data.type==='ice') {
      pc.addIceCandidate(data.candidate);
    } else if(data.type==='chat') {
      addChat('Partner', data.message);
    } else if(data.type==='system') {
      addChat('System', data.message);
    }
  };
}

function createPeerConnection() {
  pc = new RTCPeerConnection();
  pc.onicecandidate = e => { if(e.candidate) ws.send(JSON.stringify({type:'ice', candidate:e.candidate})); };
  pc.ontrack = e => { remoteVideo.srcObject = e.streams[0]; };
  localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
}

async function startSession() {
  if(!localStream) await startCamera();
  if(!ws || ws.readyState!==WebSocket.OPEN) initWebSocket();
  if(!pc) createPeerConnection();

  pc.createOffer()
    .then(offer => pc.setLocalDescription(offer))
    .then(()=>ws.send(JSON.stringify({type:'offer', offer:pc.localDescription})));
}

function endSession() {
  if(ws && ws.readyState===WebSocket.OPEN) {
    ws.send(JSON.stringify({type:'system', message:'Partner zakończył rozmowę'}));
  }
  if(pc) { pc.close(); pc=null; }
  if(localStream) { localStream.getTracks().forEach(t=>t.stop()); localStream=null; localVideo.srcObject=null; }
}

startBtn.onclick = startSession;
anonBtn.onclick = loginBtn.onclick = () => { loginModal.style.display='none'; startSession(); };
sendBtn.onclick = () => {
  const t = chatText.value.trim();
  if(!t) return;
  chatText.value='';
  addChat('Ty', t);
  ws.send(JSON.stringify({type:'chat', message:t}));
};
muteBtn.onclick = () => {
  if(localStream) { isMuted=!isMuted; localStream.getAudioTracks().forEach(t=>t.enabled=!isMuted); }
};
nextBtn.onclick = () => { addChat('System','Przechodzisz do następnego'); endSession(); startSession(); };
stopBtn.onclick = () => { addChat('System','Sesja zakończona'); endSession(); };

chatText.addEventListener('keypress', e => { if(e.key==='Enter'){ e.preventDefault(); sendBtn.click(); } });
</script>

</body>
</html>
