<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pogadaj24 — Prototype</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#000;
  --fg:#fff;
  --card:#111;
  --accent:#0ff;
  --chat-bg:#111;
}
.light{
  --bg:#f4f4f4;
  --fg:#000;
  --card:#fff;
  --accent:#0077ff;
  --chat-bg:#eaeaea;
}
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:var(--bg);
  color:var(--fg);
  transition:0.3s;
}
.container{ max-width:1200px; margin:auto; padding:10px; }
.app-header{
  text-align:center;
  padding:20px;
  font-size:2.5em;
  font-weight:700;
  color:var(--accent);
  text-shadow:0 0 15px var(--accent),0 0 30px var(--accent);
  animation: glow 2s infinite alternate;
  position:relative;
}
.theme-toggle{
  position:absolute;
  top:15px;
  right:20px;
  font-size:1.2em;
  cursor:pointer;
  user-select:none;
  color:var(--accent);
}
@keyframes glow{
  from{ text-shadow:0 0 10px var(--accent),0 0 20px var(--accent); }
  to{ text-shadow:0 0 25px var(--accent),0 0 50px var(--accent); }
}
.card{
  background:var(--card);
  border-radius:12px;
  padding:15px;
  margin:10px 0;
  transition:background 0.3s, box-shadow 0.3s;
  box-shadow:0 0 12px rgba(0,255,255,0.2);
  border:2px solid var(--accent);
}
.btn{
  padding:10px 20px;
  margin:5px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  position:relative;
  overflow:hidden;
}
.btn.neon{
  background:var(--accent);
  color:#000;
  animation:pulse 1.5s infinite;
}
@keyframes pulse{
  0%,100%{ box-shadow:0 0 10px var(--accent),0 0 20px var(--accent);}
  50%{ box-shadow:0 0 25px var(--accent),0 0 50px var(--accent);}
}
.video-stage{
  position:relative;
  width:100%;
  height:450px;
  background:#000;
  border-radius:12px;
  overflow:hidden;
  border:3px solid var(--accent);
  box-shadow:0 0 30px var(--accent);
}
#remote{ width:100%; height:100%; object-fit:cover; }
.local-thumb{
  position:absolute;
  bottom:10px;
  right:10px;
  width:220px;
  height:165px;
  border:2px solid var(--accent);
  border-radius:10px;
  overflow:hidden;
  box-shadow:0 0 25px var(--accent);
}
.local-thumb video{ width:100%; height:100%; object-fit:cover; }
.chat-box{
  height:250px;
  overflow-y:auto;
  background:var(--chat-bg);
  padding:10px;
  border-radius:10px;
  border:2px solid var(--accent);
  font-size:0.95em;
}
.chat-message{ animation: fadeIn 0.5s; }
@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}
.chat-input{ display:flex; gap:5px; }
.input{ flex:1; padding:8px; border-radius:4px; border:2px solid var(--accent); background:var(--card); color:var(--fg); }
.footer{ text-align:center; margin-top:20px; color:#888; }
.modal{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; align-items:center; justify-content:center; }
.modal .panel{ background:var(--card); padding:20px; border-radius:12px; text-align:center; color:var(--fg); }
.mic-muted{ animation:pulse 1.2s infinite; }
.status-dot{ position:absolute; top:10px; left:10px; width:15px; height:15px; border-radius:50%; background:red; box-shadow:0 0 10px var(--accent);}
.status-dot.connected{background:lime;}
.status-dot.connecting{background:orange;}
@media(max-width:768px){
  .video-stage{height:300px;}
  .local-thumb{width:140px;height:105px;}
  .chat-box{height:200px;}
  .app-header{font-size:2em;}
}
</style>
</head>
<body>
<div class="container">
  <header class="app-header">
    Pogadaj24
    <div id="themeToggle" class="theme-toggle" title="Zmień motyw">🌙</div>
  </header>

  <main style="display:flex;gap:18px;flex-wrap:wrap;justify-content:center;">
    <section class="card" style="flex:1;min-width:300px;max-width:650px;">
      <div class="video-stage">
        <div class="status-dot connecting" id="statusDot"></div>
        <video id="remote" autoplay playsinline></video>
        <div class="local-thumb"><video id="local" autoplay playsinline muted></video></div>
      </div>
      <div class="action-bar">
        <button id="startBtn" class="btn neon">Start</button>
        <button id="nextBtn" class="btn neon">Next</button>
        <button id="muteBtn" class="btn neon">Mute</button>
        <button id="stopBtn" class="btn neon">Stop</button>
      </div>
    </section>

    <aside class="card" style="flex:1;min-width:250px;max-width:400px;">
      <div class="chat-box" id="chatBox"></div>
      <div class="chat-input">
        <input id="chatText" class="input" placeholder="Napisz wiadomość...">
        <button id="sendBtn" class="btn neon">Wyślij</button>
      </div>
    </aside>
  </main>

  <footer class="footer">&copy; Pogadaj24 — prototyp</footer>
</div>

<div class="modal" id="loginModal">
  <div class="panel">
    <h2>Witaj w Pogadaj24</h2>
    <p>Wybierz opcję aby rozpocząć:</p>
    <button id="anonBtn" class="btn ghost" style="margin-right:6px;">Wejdź anonimowo</button>
    <button id="loginBtn" class="btn neon">Zaloguj (demo)</button>
  </div>
</div>

<script>
const WEBSOCKET_URL='wss://pogadaj24.onrender.com';
const localVideo=document.getElementById('local');
const remoteVideo=document.getElementById('remote');
const startBtn=document.getElementById('startBtn');
const nextBtn=document.getElementById('nextBtn');
const muteBtn=document.getElementById('muteBtn');
const stopBtn=document.getElementById('stopBtn');
const chatBox=document.getElementById('chatBox');
const sendBtn=document.getElementById('sendBtn');
const chatText=document.getElementById('chatText');
const loginModal=document.getElementById('loginModal');
const anonBtn=document.getElementById('anonBtn');
const loginBtn=document.getElementById('loginBtn');
const themeToggle=document.getElementById('themeToggle');
const statusDot=document.getElementById('statusDot');

let localStream=null, pc=null, ws=null, isMuted=false;

function setTheme(mode){
  if(mode==='light'){ document.body.classList.add('light'); themeToggle.textContent='☀️'; localStorage.setItem('theme','light'); }
  else{ document.body.classList.remove('light'); themeToggle.textContent='🌙'; localStorage.setItem('theme','dark'); }
}
themeToggle.onclick=()=>setTheme(document.body.classList.contains('light')?'dark':'light');
setTheme(localStorage.getItem('theme')||'dark');

function clearChat(){ chatBox.innerHTML=''; }
function addChat(who,msg){ const el=document.createElement('div'); el.className='chat-message'; el.innerHTML=`<strong>${who}:</strong> ${msg}`; chatBox.appendChild(el); chatBox.scrollTop=chatBox.scrollHeight; }

async function startCamera(){
  try{
    localStream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720}},audio:true});
    localVideo.srcObject=localStream;
  }catch(err){
    alert('Nie udało się uzyskać dostępu do kamery/mikrofonu. Sprawdź uprawnienia.');
    console.error(err);
  }
}

function initWebSocket(){
  ws=new WebSocket(WEBSOCKET_URL);
  ws.onopen=()=>console.log('WS connected');
  ws.onmessage=e=>{
    const data=JSON.parse(e.data);
    if(data.type==='offer'){
      if(!pc) createPeerConnection();
      pc.setRemoteDescription(data.offer)
        .then(()=>pc.createAnswer())
        .then(ans=>pc.setLocalDescription(ans))
        .then(()=>ws.send(JSON.stringify({type:'answer',answer:pc.localDescription})));
    }else if(data.type==='answer'){ pc.setRemoteDescription(data.answer); }
    else if(data.type==='ice'){ pc.addIceCandidate(data.candidate); }
    else if(data.type==='chat'){ addChat('Partner',data.message); }
    else if(data.type==='system' && data.message.includes('Partner rozłączył')){ clearChat(); }
  };
}

function createPeerConnection(){
  pc=new RTCPeerConnection();
  pc.onicecandidate=e=>{ if(e.candidate) ws.send(JSON.stringify({type:'ice',candidate:e.candidate})); };
  pc.ontrack=e=>{ remoteVideo.srcObject=e.streams[0]; statusDot.className='status-dot connected'; };
  if(localStream) localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
}

async function startSession(){
  if(!localStream) await startCamera();
  if(!ws || ws.readyState!==WebSocket.OPEN) initWebSocket();
  if(!pc) createPeerConnection();
  pc.createOffer().then(offer=>pc.setLocalDescription(offer))
    .then(()=>ws.send(JSON.stringify({type:'offer',offer:pc.localDescription})));
  statusDot.className='status-dot connecting';
}

function stopSession(){
  if(pc){ pc.close(); pc=null; }
  clearChat();
  remoteVideo.srcObject=null;
  addChat('System','Sesja zatrzymana');
  statusDot.className='status-dot connecting';
}

function nextSession(){
  stopSession();
  addChat('System','Szukam nowego partnera...');
  setTimeout(()=>startSession(),500);
}

startBtn.onclick=startSession;
anonBtn.onclick=loginBtn.onclick=()=>{ loginModal.style.display='none'; startSession(); };
sendBtn.onclick=()=>{ const t=chatText.value.trim(); if(!t)return; chatText.value=''; addChat('Ty',t); ws.send(JSON.stringify({type:'chat',message:t})); };
muteBtn.onclick=()=>{
  if(localStream){ isMuted=!isMuted; localStream.getAudioTracks().forEach(t=>t.enabled=!isMuted);
  addChat('System',isMuted?'Mikrofon wyciszony':'Mikrofon włączony');
  muteBtn.classList.toggle('mic-muted',isMuted);
  }
};
nextBtn.onclick=nextSession;
stopBtn.onclick=stopSession;
chatText.addEventListener('keypress',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendBtn.click(); } });
</script>
</body>
</html>
